# node_exporter.yml
#
# Purpose:
#   Deploys Prometheus Node Exporter across all Swarm nodes.
#   Collects and exposes system-level metrics (CPU, RAM, disk, etc.) on port 9100.
#   Metrics are used for monitoring, alerting, and service rebalancing decisions.
#
# Deployment:
#   - Runs globally: one replica per node.
#   - Uses host networking to expose metrics directly to Prometheus or other scrapers.
#   - Mounts critical system folders for accurate metrics.
#   - Configured for SWAG auto-discovery and Uptime Kuma monitoring.

name: node_exporter
image: prom/node-exporter:latest

args:
# Custom paths for host system mounts
- --path.procfs=/host/proc
- --path.rootfs=/rootfs
- --path.sysfs=/host/sys
# Exclude irrelevant filesystem mount points
- --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
# Enable textfile collector for custom metrics
- --collector.textfile.directory=/var/lib/node_exporter/textfile_collector

mounts:
# Mount important system folders into container
- source: /proc
  target: /host/proc
  read_only: true
- source: /sys
  target: /host/sys
  read_only: true
- source: /
  target: /rootfs
  read_only: true
- source: /var/lib
  target: /var/lib
  read_only: false
- source: /var/log
  target: /var/log
  read_only: false
- source: /etc/timezone
  target: /etc/timezone
  read_only: true
- source: /etc/localtime
  target: /etc/localtime
  read_only: true

timezone:
  bind_local: true # Mount timezone from host
  env_tz: true # Propagate host timezone to container environment

networks:
- monitor-net # Monitoring network for Prometheus or external scrapers

ports:
- published: 9100
  target: 9100
  protocol: tcp
  mode: host # Host mode to expose raw node metrics directly

deploy:
  mode: global # One replica per node
  endpoint_mode: vip
  placement:
    constraints:
    - node.platform.os == linux # Only deploy on Linux nodes
  labels:
    compose.version: "full" # Compose extension tracking
    swarm.stack: "swarm-dev" # Stack assignment label
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 2
    window: 60s

labels:
  org.label-schema.group: monitoring # Group label for service organization
  swag: enable # Enable SWAG (auto nginx routing)
  swag.uptime-kuma.enabled: true # Enable Uptime Kuma monitoring
  swag.uptime-kuma.monitor.name: Node-Exporter
  swag.uptime-kuma.monitor.url: https://node-exporter.${TLD}

stop_grace_period: 30s
stop_signal: SIGTERM

healthcheck:
  test: [ "CMD-SHELL", "wget -qO- http://127.0.0.1:9100/metrics || exit 1" ]
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 20s

logging:
  driver: json-file
  options:
    max-size: 10m
    max-file: 5
